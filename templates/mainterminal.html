<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jeep Terminal - 4 Terminals + Main Destination</title>

  <style>
  /* ---------- GLOBAL ---------- */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --muted:#8b8f96;
    --accent:#4a6cf7;
    --jeep-yellow:#ffdf7a;
    --panel-radius:12px;
    --soft-shadow: 0 6px 18px rgba(16,24,40,0.06);
  }

  html,body{
    height:100%;
    margin:0;
    font-family:"Inter", Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg), #eef2f7 120px);
    color:#222;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:22px;
    box-sizing:border-box;
  }

  h3{
    margin:0 0 10px 0;
    font-size:18px;
    font-weight:600;
    color:#222;
    letter-spacing:0.2px;
  }

  /* ---------- GRID LAYOUT ---------- */
  .layout{
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:auto auto;
    grid-template-areas:
      "info main"
      "queue origin";
    gap:20px;
    align-items:start;
  }

  .panel, .panel1{
    background:var(--card);
    border-radius:var(--panel-radius);
    padding:16px;
    box-shadow:var(--soft-shadow);
    border: 1px solid rgba(16,24,40,0.03);
  }

  #infoPanel{ grid-area:info; }
  #mainTerminalPanel{ grid-area:main; }
  #queuePanel{ grid-area:queue; }
  #originPanel{ grid-area:origin; }

  /* ---------- INFO PANEL ---------- */
  #infoPanel p{
    margin:8px 0;
    color:var(--muted);
    font-size:14px;
  }
  #infoPanel strong{ color:#333; font-weight:600; }

  /* ---------- JEEP (vertical base) ---------- */
  .jeep-vertical, .main-jeep, .origin-jeep {
    transition: transform .18s ease, box-shadow .18s ease;
    cursor:pointer;
  }
  .jeep-vertical:hover, .main-jeep:hover, .origin-jeep:hover{
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 10px 30px rgba(16,24,40,0.12);
  }

  /* base vertical jeep (portrait) */
  .jeep-vertical{
    width:90px;
    height:180px;
    border-radius:60px 60px 12px 12px;
    border:2px solid rgba(0,0,0,0.12);
    background: linear-gradient(180deg,#fffef0,#fff9c4);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    padding-bottom:10px;
    position:relative;
    box-shadow: inset 0 -6px 12px rgba(0,0,0,0.02);
  }
  .jeep-vertical::before{
    content:"";
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    width:62px;
    height:36px;
    background:#d7e9ff;
    border:2px solid rgba(0,0,0,0.14);
    border-radius:20px;
  }
  .terminal-label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
  .jeep-id{ font-weight:700; font-size:14px; color:#222; }
  .jeep-count{ font-size:12px; color:var(--muted); }

  /* flip styling kept (top jeeps show back view) */
  .jeep-flip{ transform: scaleY(-1); }
  .jeep-flip .terminal-label,
  .jeep-flip .jeep-id,
  .jeep-flip .jeep-count { transform: scaleY(-1); }

  /* ---------- MAIN JEEP — centered perfectly ---------- */
  .main-jeep-wrapper{
    display:flex;
    justify-content:center;
    align-items:center;      /* vertical center */
    height:260px;            /* gives vertical space to center in panel */
    padding:6px 0;
  }

  /* ensure responsive smaller heights still center */
  @media (max-height:620px){
    .main-jeep-wrapper{ height:200px; }
  }
  @media (max-width:720px){
    .layout{ grid-template-columns:1fr; grid-template-areas:"info" "main" "queue" "origin"; }
    .main-jeep-wrapper{ height:220px; }
  }

  .main-jeep-box{ display:flex; flex-direction:column; align-items:center; gap:8px; }
  .main-jeep-label{ font-weight:700; color:var(--muted); font-size:14px; }

  .main-jeep{
    width:110px;
    height:210px;
    border-radius:70px 70px 12px 12px;
    border:3px solid rgba(0,0,0,0.14);
    background: linear-gradient(180deg, #fff3c2, var(--jeep-yellow));
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    padding-bottom:12px;
    position:relative;
    box-shadow: 0 10px 28px rgba(16,24,40,0.10);
  }
  .main-jeep::before{
    content:"";
    position:absolute;
    top:12px;
    left:50%;
    transform:translateX(-50%);
    width:72px;
    height:40px;
    background:#d7e9ff;
    border-radius:24px;
    border:2px solid rgba(0,0,0,0.14);
  }
  .main-jeep-empty{ opacity:0.62; filter:grayscale(.05); }

  /* ---------- QUEUE (horizontal cars) ---------- */
  .queue-cars{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; align-items:center; }
  .jeep-horizontal{
    min-width:150px;
    height:84px;
    border-radius:18px 50px 50px 18px;
    border:2px solid rgba(0,0,0,0.10);
    background: linear-gradient(90deg,#fffef0,#fff9c4);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-start;
    padding:10px 14px;
    position:relative;
    box-shadow: inset 0 -6px 10px rgba(0,0,0,0.02);
  }
  .jeep-horizontal::before{
    content:"";
    position:absolute;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    width:28px;
    height:38px;
    background:#d7e9ff;
    border-radius:8px;
    border:2px solid rgba(0,0,0,0.14);
  }
  .jeep-horizontal .jeep-id{ font-weight:700; margin-left:36px; font-size:13px; }
  .jeep-horizontal .jeep-count{ margin-left:36px; color:var(--muted); font-size:13px; }

  /* ---------- ORIGIN GRID & ORIGIN JEEPS ---------- */
  .jeep-grid{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:18px 22px;
    justify-items:center;
    margin-top:14px;
  }

  .origin-jeep{
    width:120px;
    height:200px;
    border-radius:70px 70px 12px 12px;
    background: linear-gradient(180deg,#fffdf0,#fff4c9);
    border:2px solid rgba(0,0,0,0.08);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    padding-bottom:14px;
    position:relative;
    box-shadow: 0 6px 18px rgba(16,24,40,0.06);
  }
  .origin-jeep::before{
    content:"";
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    width:62px;
    height:36px;
    background:#d7e9ff;
    border-radius:16px;
    border:2px solid rgba(0,0,0,0.12);
  }
  .origin-label{ font-size:12px; font-weight:700; margin-top:6px; color:#222; }
  .origin-plate{ font-size:12px; color:var(--muted); margin-top:6px; }
  .origin-count{ font-size:13px; font-weight:600; margin-top:8px; color:#222; }

  /* ---------- MODAL & SEATS ---------- */
  .modal-bg{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background: rgba(4,10,22,0.55); z-index:10000;
  }
  .modal{
    width:380px;
    background:var(--card);
    padding:20px;
    border-radius:12px;
    box-shadow: 0 18px 50px rgba(16,24,40,0.24);
  }
  .jeepney-layout{
    width:100%;
    background:#fafafb;
    padding:14px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.06);
    margin-top:8px;
  }
  .jeepney-front{ display:flex; justify-content:space-between; margin-bottom:12px; }
  .driver-box{ flex:1; height:42px; background:#e6e9ee; border-radius:8px; display:flex; align-items:center; padding-left:10px; font-weight:700; color:#333; border:1px solid rgba(0,0,0,0.04); }
  .front-seats{ display:flex; gap:8px; }
  .seat-square{ width:38px; height:38px; border-radius:6px; display:flex; align-items:center; justify-content:center; position:relative; font-weight:700; color:#fff; }
  .seat-square .seat-num{ position:absolute; bottom:4px; right:6px; font-size:10px; opacity:0.95; text-shadow:0 1px 0 rgba(0,0,0,0.25); }
  .filled{ background:#2e8b57; }
  .empty{ background:#d0d4d8; color:#222; }

  .jeepney-row{ display:flex; justify-content:space-between; margin-bottom:8px; }

  .close-btn{
    margin-top:14px;
    width:100%;
    padding:10px;
    background:#ef5350;
    color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:700;
  }

  /* small helpers */
  .muted{ color:var(--muted); font-size:13px; }
</style>

</head>
<body>

<div class="layout">

  <!-- LEFT INFO PANEL -->
  <div class="panel" id="infoPanel">
    <h3>Jeep Information</h3>
    <p><strong>Jeep ID:</strong> <span id="infoId">–</span></p>
    <p><strong>From:</strong> <span id="infoLocation">–</span></p>
    <p><strong>Capacity:</strong> <span id="infoCap">–</span></p>
    <p><strong>Passengers:</strong> <span id="infoPass">–</span></p>
    <p><strong>Seats Left:</strong> <span id="infoLeft">–</span></p>
  </div>

  <!-- MAIN TERMINAL (sakayan) -->
  <div class="panel" id="mainTerminalPanel">
    <h3>Main Destination Terminal (Sakayan)</h3>
    <div class="main-jeep-wrapper">
      <div class="main-jeep-box">
        <div class="main-jeep-label" id="mainJeepLabel">Waiting for jeep...</div>
        <div class="main-jeep main-jeep-empty" id="mainJeepBox">
          <div class="jeep-id" id="mainJeepId">EMPTY</div>
          <div class="jeep-count" id="mainJeepCount">0/22</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN TERMINAL QUEUE -->
  <div class="panel" id="queuePanel">
    <h3>Main Terminal Queue (Jeeps at Main)</h3>
    <div class="queue-cars" id="queueCars"></div>
  </div>

  <!-- ORIGIN TERMINALS -->
  <div class="panel1" id="originPanel">
    <h3>Origin Terminals (Loading Jeeps)</h3>

    <div class="jeep-grid" id="originGrid"></div>

  </div>

</div>

<!-- MODAL -->
<div class="modal-bg" id="seatModalBg" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="seatModalTitle">
  <div class="modal" id="seatModal">
    <h3 id="seatModalTitle">Seats – Jeep <span id="seatJeepId"></span></h3>
    <div id="seatLayout" aria-live="polite"></div>
    <div id="seatCounts" style="margin-top:8px; font-size:13px;"></div>
    <button class="close-btn" onclick="closeSeatModal()" aria-label="Close seat modal">Close</button>
  </div>
</div>

<script>
  const CAPACITY = 22;
  const TICK_MS = 2000;
  const MAIN_TERMINAL_ID = {{ main_terminal_id }};
  // 100% full bago umalis pabalik ng origin
  const MAIN_MIN_FILL = 1.0;

  // 4 origin displays (blue boxes)
  let originJeeps = {};   // dynamic terminal → jeep mapping

  // NOW: departedQueue represents REAL queue at MAIN terminal
  let departedQueue = [];
  let mainJeep = null;      // kasalukuyang nasa main

  // UI refs
  const jeepElems = document.querySelectorAll(".jeep-vertical");
  const queueCarsEl = document.getElementById("queueCars");
  const mainJeepBox = document.getElementById("mainJeepBox");
  const mainJeepLabel = document.getElementById("mainJeepLabel");
  const mainJeepIdEl = document.getElementById("mainJeepId");
  const mainJeepCountEl = document.getElementById("mainJeepCount");

  const infoId = document.getElementById("infoId");
  const infoLocation = document.getElementById("infoLocation");
  const infoCap = document.getElementById("infoCap");
  const infoPass = document.getElementById("infoPass");
  const infoLeft = document.getElementById("infoLeft");

  const seatModalBg = document.getElementById("seatModalBg");
  const seatLayout = document.getElementById("seatLayout");
  const seatJeepId = document.getElementById("seatJeepId");
  const seatCounts = document.getElementById("seatCounts");

  /* ------------------- MODAL / SEAT RENDERING (Improved) ------------------- */

  // Build a single seat DOM node with seat number and filled state
  function createSeatNode(index, filled) {
    const node = document.createElement("div");
    node.className = `seat-square ${filled ? "filled" : "empty"}`;
    node.setAttribute("role", "img");
    node.setAttribute("aria-label", `Seat ${index + 1}: ${filled ? "occupied" : "empty"}`);

    const num = document.createElement("div");
    num.className = "seat-num";
    num.textContent = index + 1;
    node.appendChild(num);

    return node;
  }

  function showSeatModal(j) {
    if (!j) return;
    const capacity = (j.capacity == null ? CAPACITY : j.capacity);
    const taken = Math.max(0, Math.min(j.passengers == null ? 0 : j.passengers, capacity));

    seatJeepId.textContent = j.id ?? "–";
    seatLayout.innerHTML = ""; // clear old content

    const layout = document.createElement("div");
    layout.className = "jeepney-layout";

    // Front: driver + two front seats
    const front = document.createElement("div");
    front.className = "jeepney-front";
    const driver = document.createElement("div");
    driver.className = "driver-box";
    driver.textContent = "Driver";
    front.appendChild(driver);

    const frontSeats = document.createElement("div");
    frontSeats.className = "front-seats";
    frontSeats.appendChild(createSeatNode(0, 0 < taken));
    frontSeats.appendChild(createSeatNode(1, 1 < taken));
    front.appendChild(frontSeats);
    layout.appendChild(front);

    // Remaining seats (pairs)
    let index = 2;
    const remaining = Math.max(0, capacity - 2);
    const rows = Math.ceil(remaining / 2);
    for (let r = 0; r < rows; r++) {
      const row = document.createElement("div");
      row.className = "jeepney-row";
      row.appendChild(createSeatNode(index, index < taken));
      index++;
      row.appendChild(createSeatNode(index, index < taken));
      index++;
      layout.appendChild(row);
    }

    seatLayout.appendChild(layout);

    // seat counts (text)
    seatCounts.textContent = `${taken} / ${capacity} passengers`;

    // show modal
    seatModalBg.style.display = "flex";
    seatModalBg.setAttribute("aria-hidden", "false");
  }

  function closeSeatModal() {
    seatModalBg.style.display = "none";
    seatModalBg.setAttribute("aria-hidden", "true");
  }

  // allow Esc to close modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSeatModal();
  });

  /* ------------------- INFO PANEL ------------------- */

  function clearInfo() {
    infoId.textContent = "–";
    infoLocation.textContent = "–";
    infoCap.textContent = "–";
    infoPass.textContent = "–";
    infoLeft.textContent = "–";
  }

  function updateInfo(j) {
    if (!j) return;
    infoId.textContent = j.id ?? "–";
    infoLocation.textContent = j.terminalName || j.originName || "Main Terminal";
    infoCap.textContent = j.capacity ?? CAPACITY;
    infoPass.textContent = j.passengers ?? 0;
    infoLeft.textContent = (j.capacity ?? CAPACITY) - (j.passengers ?? 0);
  }

  /* ------------------- RENDERING ------------------- */

  function renderMainJeep() {
    if (!mainJeep) {
      mainJeepBox.classList.add("main-jeep-empty");
      mainJeepIdEl.textContent = "EMPTY";
      mainJeepCountEl.textContent = "0/22";
      mainJeepLabel.textContent = "Waiting for jeep...";

      // Jeep Information panel: nothing at main
      clearInfo();
      return;
    }

    mainJeepBox.classList.remove("main-jeep-empty");
    mainJeepIdEl.textContent = `Jeep ${mainJeep.id}`;
    mainJeepCountEl.textContent = `${mainJeep.passengers}/${mainJeep.capacity}`;

    if (mainJeep.phase === "unloading") {
      mainJeepLabel.textContent = `Unloading (from ${mainJeep.originName})`;
    } else {
      mainJeepLabel.textContent = `Loading (to ${mainJeep.originName})`;
    }

    // Always sync Jeep Information with the jeep at Main Terminal
    updateInfo(mainJeep);
  }

  function renderQueue() {
    queueCarsEl.innerHTML = "";
    departedQueue.forEach(j => {
      const d = document.createElement("div");
      d.className = "jeep-horizontal";
      d.innerHTML = `
        <div class="jeep-id">Jeep ${j.id}</div>
        <div class="jeep-count">${j.passengers}/${j.capacity}</div>
        <div style="font-size:11px;">At Main Terminal</div>
      `;
      d.onclick = () => {
        updateInfo(j);
        showSeatModal(j);
      };
      queueCarsEl.appendChild(d);
    });
  }

  function renderOriginJeeps() {
    const grid = document.getElementById("originGrid");
    grid.innerHTML = "";

    Object.values(originJeeps).forEach(j => {
      const el = document.createElement("div");
      el.className = "origin-jeep";
      el.dataset.terminal = j.terminalId;
      el.innerHTML = `
        <div class="origin-label">${j.terminalName}</div>
        <div class="origin-plate">${j.plate ? j.plate : "No Plate"}</div>
        <div class="origin-count">${j.passengers}/${j.capacity} seats</div>
        <div class="origin-from">From Terminal ${j.terminalId}</div>
      `;
      el.onclick = () => {
        updateInfo(j);
        showSeatModal(j);
      };
      grid.appendChild(el);
    });
  }

  /* ------------------- ARRIVAL LOGIC ------------------- */

  function jeepArrivesAtMain(incoming) {
    mainJeep = {
      id: incoming.id,
      originName: incoming.originName,
      originTerminalId: incoming.originTerminalId,
      passengers: incoming.passengers,
      capacity: incoming.capacity,
      terminalName: "Main Terminal",
      phase: "unloading"
    };
  }

  /* ------------------- MAIN CYCLE ------------------- */

  function simulateMain() {
    // If no jeep at main → take next from queue
    if (!mainJeep && departedQueue.length > 0) {
      jeepArrivesAtMain(departedQueue.shift());
    }

    if (!mainJeep) return;

    if (mainJeep.phase === "unloading") {
      // remove 1-2 passengers (random for realism)
      const remove = 1 + Math.floor(Math.random() * 2);
      mainJeep.passengers = Math.max(0, (mainJeep.passengers || 0) - remove);

      // persist to backend (best-effort)
      fetch(`/api/terminal/${MAIN_TERMINAL_ID}/jeepneys/${mainJeep.id}/passengers`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passengers: mainJeep.passengers })
      }).catch(err => console.error("Failed to update passengers (unload)", err));

      if (mainJeep.passengers === 0) {
        mainJeep.phase = "loading";
      }
    }

    else if (mainJeep.phase === "loading") {
      // add 1-2 passengers
      const add = 1 + Math.floor(Math.random() * 2);
      mainJeep.passengers = Math.min(mainJeep.capacity || CAPACITY, (mainJeep.passengers || 0) + add);

      // persist to backend (best-effort)
      fetch(`/api/terminal/${MAIN_TERMINAL_ID}/jeepneys/${mainJeep.id}/passengers`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passengers: mainJeep.passengers })
      }).catch(err => console.error("Failed to update passengers (load)", err));

      const needed = (mainJeep.capacity || CAPACITY) * MAIN_MIN_FILL;

      if (mainJeep.passengers >= needed) {
        // MAIN → ORIGIN departure
        fetch("/api/trips/depart-from-main", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            jeepney_id: mainJeep.id,
            passengers: mainJeep.passengers
          })
        })
        .then(r => {
          if (!r.ok) return r.json().then(x => { throw x; });
          return r.json();
        })
        .then(() => {
          // after one full cycle, reload data
          loadOriginJeepsFromDB();
          loadMainQueueFromDB();
        })
        .catch(err => console.error("Error depart-from-main:", err));

        mainJeep = null;
      }
    }
  }

  /* ------------------- TICK ------------------- */

  function tick() {
    simulateMain();
    renderOriginJeeps();
    renderQueue();
    renderMainJeep();
  }

  if (!window.__mainTerminalTickId) {
    window.__mainTerminalTickId = setInterval(tick, TICK_MS);
  }
  /* ------------------- LOAD INITIAL DATA ------------------- */

  jeepElems.forEach(el => {
    el.addEventListener("click", () => {
      const idx = parseInt(el.dataset.index, 10);
      const j = originJeeps[idx];
      if (!j || !j.id) return;
      updateInfo(j);
      showSeatModal(j);
    });
  });

  mainJeepBox.addEventListener("click", () => {
    if (!mainJeep) return;
    updateInfo(mainJeep);
    showSeatModal(mainJeep);
  });

  // Load the 4 "origin jeeps" (summary of latest departed jeeps heading to main)
  function loadOriginJeepsFromDB() {
    fetch("/api/main/origin-jeeps")
      .then(r => r.json())
      .then(data => {

        originJeeps = {}; // reset

        data.forEach(row => {
          originJeeps[row.terminal_id] = {
            id: row.jeepney_id,
            terminalId: row.terminal_id,
            terminalName: row.terminal_name,
            plate: row.plate_number,
            passengers: row.passengers ?? 0,
            capacity: row.capacity ?? CAPACITY
          };
        });

        renderOriginJeeps();
      })
      .catch(err => console.error("Origin load error:", err));
  }


  // NEW: load REAL queue at main from DB
  function loadMainQueueFromDB() {
    fetch(`/api/terminal/${MAIN_TERMINAL_ID}/queue`)
      .then(r => r.json())
      .then(data => {
        departedQueue.length = 0;

        data.forEach(row => {
          const capacity = row.capacity ?? CAPACITY;
          const passengers = row.passengers ?? 0;

          departedQueue.push({
            id: row.jeepney_id,
            originName: "Main Terminal Queue",
            originTerminalId: MAIN_TERMINAL_ID,
            passengers,
            capacity,
            terminalName: "Main Terminal"
          });
        });

        // If no jeep currently at main, pull first from queue
        if (!mainJeep && departedQueue.length > 0) {
          jeepArrivesAtMain(departedQueue.shift());
        }

        renderQueue();
        renderMainJeep();
      })
      .catch(err => console.error("Error loading main queue:", err));
  }

  // initial load
  loadOriginJeepsFromDB();
  loadMainQueueFromDB();
</script>

</body>
</html>
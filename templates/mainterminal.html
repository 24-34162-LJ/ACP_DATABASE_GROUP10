<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jeep Terminal - 4 Terminals + Main Destination</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#f3f3f3;
      padding:20px;
    }


    /* ===================== LAYOUT GRID ===================== */
    .layout {
      display:grid;
      grid-template-columns:260px 1fr;   /* left narrow, right wide */
      grid-template-rows:auto auto;      /* 2 rows */
      grid-template-areas:
        "info main"
        "queue origin";
      gap:20px;
    }

    .panel,
    .panel1 {
      background:#fff;
      border-radius:8px;
      box-shadow:0 0 5px rgba(0,0,0,.1);
      padding:12px 15px 18px;
    }

    /* place each panel in the grid */
    #infoPanel {
      grid-area: info;
    }

    #mainTerminalPanel {
      grid-area: main;
    }

    #queuePanel {
      grid-area: queue;
    }

    #originPanel {
      grid-area: origin;
    }

    /* ===================== ACTIVE JEEPS (4 TERMINALS) ===================== */
    .jeep-grid {
      display:grid;
      grid-template-columns:repeat(2, auto);
      gap:50px 150px;  /* row, column */
      justify-content:center;
      margin-top:20px;
    }

    /* base vertical jeep (facing down / front view) */
    .jeep-vertical {
      width:90px;
      height:180px;
      border-radius:60px 60px 10px 10px;
      border:2px solid #555;
      background:#fffde7;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      padding-bottom:8px;
      cursor:pointer;
      position:relative;
      transition:0.2s;
    }

    .jeep-vertical:hover { transform:scale(1.05); }

    /* windshield on top */
    .jeep-vertical::before {
      content:"";
      position:absolute;
      top:8px;
      left:50%;
      transform:translateX(-50%);
      width:60px;
      height:35px;
      background:#d7e9ff;
      border:2px solid #333;
      border-radius:20px;
    }

    /* TOP JEEPS: flip (back view) */
    .jeep-flip {
      transform:scaleY(-1);         /* flip whole jeep */
    }
    .jeep-flip .terminal-label,
    .jeep-flip .jeep-id,
    .jeep-flip .jeep-count {
      transform:scaleY(-1);         /* text back to normal */
    }

    .terminal-label {
      font-size:12px;
      margin-bottom:2px;
    }
    .jeep-id { font-weight:bold; font-size:13px; }
    .jeep-count { font-size:12px; }

    /* ===================== MAIN TERMINAL JEEP (CENTER) ===================== */
    .main-jeep-wrapper {
      display:flex;
      justify-content:center;
      margin-top:10px;
    }

    .main-jeep-box {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }

    .main-jeep-label {
      font-weight:bold;
      margin-bottom:4px;
    }

    .main-jeep {
      width:100px;
      height:200px;
      border-radius:65px 65px 10px 10px;
      border:3px solid #444;
      background:#ffe082;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      padding-bottom:10px;
      cursor:pointer;
      position:relative;
      transition:0.2s;
      box-shadow:0 4px 10px rgba(0,0,0,.2);
    }

    .main-jeep::before {
      content:"";
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      width:70px;
      height:40px;
      background:#d7e9ff;
      border:2px solid #333;
      border-radius:22px;
    }

    .main-jeep:hover {
      transform:scale(1.04);
    }

    .main-jeep-empty {
      opacity:0.5;
    }

    /* ===================== QUEUE JEEPS (HORIZONTAL, ARRIVED FULL JEEPS) ===================== */
    .jeep-horizontal {
      width:160px;
      height:80px;
      border-radius:20px 60px 60px 20px; /* curved left front */
      border:2px solid #555;
      background:#fffde7;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding-left:10px;
      cursor:pointer;
      position:relative;
      transition:0.2s;
    }

    .jeep-horizontal:hover { transform:scale(1.05); }

    .jeep-horizontal::before {
      content:"";
      position:absolute;
      left:8px;
      top:50%;
      transform:translateY(-50%);
      width:30px;
      height:40px;
      background:#d7e9ff;
      border:2px solid #333;
      border-radius:10px;
    }

    .queue-cars {
      display:flex;
      flex-direction:row;
      gap:12px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    /* ===================== MODAL ===================== */
    .modal-bg {
      position:fixed;
      left:0; top:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:10000;
    }

    .modal {
      background:white;
      padding:20px;
      width:350px;
      border-radius:10px;
      animation:pop 0.25s ease;
    }

    @keyframes pop {
      from { transform:scale(0.8); opacity:0; }
      to { transform:scale(1); opacity:1; }
    }

    /* ===================== 22-SEAT JEEPNEY LAYOUT ===================== */
    .jeepney-layout {
      width: 260px;
      margin: auto;
      background: #f0f0f0;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid #999;
    }

    .jeepney-front {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .driver-box {
      flex: 1;
      height: 40px;
      background: #ddd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding-left: 6px;
      font-size: 14px;
      font-weight: bold;
    }

    .front-seats {
      display: flex;
      gap: 5px;
    }

    .seat-square {
      width: 35px;
      height: 35px;
      border-radius: 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:visible;
    }

    .seat-square > .seat-num {
      font-size:10px;
      position:absolute;
      bottom:2px;
      right:2px;
      color:rgba(255,255,255,0.9);
      font-weight:bold;
      text-shadow:0 1px 0 rgba(0,0,0,0.3);
    }

    .filled { background:#4caf50; color:#fff; }
    .empty  { background:#ccc; color:#222; }

    .jeepney-row {
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
    }

    .side-seat {
      width:40px;
      height:35px;
      border-radius:4px;
    }

    .close-btn {
      margin-top:15px;
      width:100%;
      padding:10px;
      background:#f44336;
      color:white;
      border:none;
      border-radius:5px;
      cursor:pointer;
    }
    /* ===================== ORIGIN TERMINAL JEEP STYLE (Improved) ===================== */
    .origin-jeep {
      width: 110px;
      height: 190px;
      border-radius: 60px 60px 10px 10px;
      border: 2px solid #444;
      background: linear-gradient(#fffde7, #fff6c2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      cursor: pointer;
      padding-bottom: 10px;
      position: relative;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transition: 0.2s;
    }

    .origin-jeep:hover {
      transform: scale(1.06);
    }

    .origin-jeep::before {
      content: "";
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 65px;
      height: 38px;
      background:#d7e9ff;
      border: 2px solid #333;
      border-radius: 20px;
    }

    .origin-label {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 2px;
      color: #333;
    }

    .origin-plate {
      font-size: 12px;
      font-weight: bold;
      color: #444;
    }

    .origin-count {
      font-size: 12px;
      margin-top: 2px;
      color: #333;
    }

    .origin-from {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }

        

  </style>
</head>
<body>

<div class="layout">

  <!-- LEFT INFO PANEL -->
  <div class="panel" id="infoPanel">
    <h3>Jeep Information</h3>
    <p><strong>Jeep ID:</strong> <span id="infoId">–</span></p>
    <p><strong>From:</strong> <span id="infoLocation">–</span></p>
    <p><strong>Capacity:</strong> <span id="infoCap">–</span></p>
    <p><strong>Passengers:</strong> <span id="infoPass">–</span></p>
    <p><strong>Seats Left:</strong> <span id="infoLeft">–</span></p>
  </div>

  <!-- MAIN TERMINAL (sakayan) -->
  <div class="panel" id="mainTerminalPanel">
    <h3>Main Destination Terminal (Sakayan)</h3>
    <div class="main-jeep-wrapper">
      <div class="main-jeep-box">
        <div class="main-jeep-label" id="mainJeepLabel">Waiting for jeep...</div>
        <div class="main-jeep main-jeep-empty" id="mainJeepBox">
          <div class="jeep-id" id="mainJeepId">EMPTY</div>
          <div class="jeep-count" id="mainJeepCount">0/22</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN TERMINAL QUEUE -->
  <div class="panel" id="queuePanel">
    <h3>Main Terminal Queue (Jeeps at Main)</h3>
    <div class="queue-cars" id="queueCars"></div>
  </div>

  <!-- ORIGIN TERMINALS -->
  <div class="panel1" id="originPanel">
    <h3>Origin Terminals (Loading Jeeps)</h3>

    <div class="jeep-grid" id="originGrid"></div>

  </div>

</div>

<!-- MODAL -->
<div class="modal-bg" id="seatModalBg" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="seatModalTitle">
  <div class="modal" id="seatModal">
    <h3 id="seatModalTitle">Seats – Jeep <span id="seatJeepId"></span></h3>
    <div id="seatLayout" aria-live="polite"></div>
    <div id="seatCounts" style="margin-top:8px; font-size:13px;"></div>
    <button class="close-btn" onclick="closeSeatModal()" aria-label="Close seat modal">Close</button>
  </div>
</div>

<script>
  const CAPACITY = 22;
  const TICK_MS = 2000;
  const MAIN_TERMINAL_ID = {{ main_terminal_id }};
  // 100% full bago umalis pabalik ng origin
  const MAIN_MIN_FILL = 1.0;

  // 4 origin displays (blue boxes)
  let originJeeps = {};   // dynamic terminal → jeep mapping

  // NOW: departedQueue represents REAL queue at MAIN terminal
  let departedQueue = [];
  let mainJeep = null;      // kasalukuyang nasa main

  // UI refs
  const jeepElems = document.querySelectorAll(".jeep-vertical");
  const queueCarsEl = document.getElementById("queueCars");
  const mainJeepBox = document.getElementById("mainJeepBox");
  const mainJeepLabel = document.getElementById("mainJeepLabel");
  const mainJeepIdEl = document.getElementById("mainJeepId");
  const mainJeepCountEl = document.getElementById("mainJeepCount");

  const infoId = document.getElementById("infoId");
  const infoLocation = document.getElementById("infoLocation");
  const infoCap = document.getElementById("infoCap");
  const infoPass = document.getElementById("infoPass");
  const infoLeft = document.getElementById("infoLeft");

  const seatModalBg = document.getElementById("seatModalBg");
  const seatLayout = document.getElementById("seatLayout");
  const seatJeepId = document.getElementById("seatJeepId");
  const seatCounts = document.getElementById("seatCounts");

  /* ------------------- MODAL / SEAT RENDERING (Improved) ------------------- */

  // Build a single seat DOM node with seat number and filled state
  function createSeatNode(index, filled) {
    const node = document.createElement("div");
    node.className = `seat-square ${filled ? "filled" : "empty"}`;
    node.setAttribute("role", "img");
    node.setAttribute("aria-label", `Seat ${index + 1}: ${filled ? "occupied" : "empty"}`);

    const num = document.createElement("div");
    num.className = "seat-num";
    num.textContent = index + 1;
    node.appendChild(num);

    return node;
  }

  function showSeatModal(j) {
    if (!j) return;
    const capacity = (j.capacity == null ? CAPACITY : j.capacity);
    const taken = Math.max(0, Math.min(j.passengers == null ? 0 : j.passengers, capacity));

    seatJeepId.textContent = j.id ?? "–";
    seatLayout.innerHTML = ""; // clear old content

    const layout = document.createElement("div");
    layout.className = "jeepney-layout";

    // Front: driver + two front seats
    const front = document.createElement("div");
    front.className = "jeepney-front";
    const driver = document.createElement("div");
    driver.className = "driver-box";
    driver.textContent = "Driver";
    front.appendChild(driver);

    const frontSeats = document.createElement("div");
    frontSeats.className = "front-seats";
    frontSeats.appendChild(createSeatNode(0, 0 < taken));
    frontSeats.appendChild(createSeatNode(1, 1 < taken));
    front.appendChild(frontSeats);
    layout.appendChild(front);

    // Remaining seats (pairs)
    let index = 2;
    const remaining = Math.max(0, capacity - 2);
    const rows = Math.ceil(remaining / 2);
    for (let r = 0; r < rows; r++) {
      const row = document.createElement("div");
      row.className = "jeepney-row";
      row.appendChild(createSeatNode(index, index < taken));
      index++;
      row.appendChild(createSeatNode(index, index < taken));
      index++;
      layout.appendChild(row);
    }

    seatLayout.appendChild(layout);

    // seat counts (text)
    seatCounts.textContent = `${taken} / ${capacity} passengers`;

    // show modal
    seatModalBg.style.display = "flex";
    seatModalBg.setAttribute("aria-hidden", "false");
  }

  function closeSeatModal() {
    seatModalBg.style.display = "none";
    seatModalBg.setAttribute("aria-hidden", "true");
  }

  // allow Esc to close modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSeatModal();
  });

  /* ------------------- INFO PANEL ------------------- */

  function clearInfo() {
    infoId.textContent = "–";
    infoLocation.textContent = "–";
    infoCap.textContent = "–";
    infoPass.textContent = "–";
    infoLeft.textContent = "–";
  }

  function updateInfo(j) {
    if (!j) return;
    infoId.textContent = j.id ?? "–";
    infoLocation.textContent = j.terminalName || j.originName || "Main Terminal";
    infoCap.textContent = j.capacity ?? CAPACITY;
    infoPass.textContent = j.passengers ?? 0;
    infoLeft.textContent = (j.capacity ?? CAPACITY) - (j.passengers ?? 0);
  }

  /* ------------------- RENDERING ------------------- */

  function renderMainJeep() {
    if (!mainJeep) {
      mainJeepBox.classList.add("main-jeep-empty");
      mainJeepIdEl.textContent = "EMPTY";
      mainJeepCountEl.textContent = "0/22";
      mainJeepLabel.textContent = "Waiting for jeep...";

      // Jeep Information panel: nothing at main
      clearInfo();
      return;
    }

    mainJeepBox.classList.remove("main-jeep-empty");
    mainJeepIdEl.textContent = `Jeep ${mainJeep.id}`;
    mainJeepCountEl.textContent = `${mainJeep.passengers}/${mainJeep.capacity}`;

    if (mainJeep.phase === "unloading") {
      mainJeepLabel.textContent = `Unloading (from ${mainJeep.originName})`;
    } else {
      mainJeepLabel.textContent = `Loading (to ${mainJeep.originName})`;
    }

    // Always sync Jeep Information with the jeep at Main Terminal
    updateInfo(mainJeep);
  }

  function renderQueue() {
    queueCarsEl.innerHTML = "";
    departedQueue.forEach(j => {
      const d = document.createElement("div");
      d.className = "jeep-horizontal";
      d.innerHTML = `
        <div class="jeep-id">Jeep ${j.id}</div>
        <div class="jeep-count">${j.passengers}/${j.capacity}</div>
        <div style="font-size:11px;">At Main Terminal</div>
      `;
      d.onclick = () => {
        updateInfo(j);
        showSeatModal(j);
      };
      queueCarsEl.appendChild(d);
    });
  }

  function renderOriginJeeps() {
    const grid = document.getElementById("originGrid");
    grid.innerHTML = "";

    Object.values(originJeeps).forEach(j => {
      const el = document.createElement("div");
      el.className = "origin-jeep";
      el.dataset.terminal = j.terminalId;
      el.innerHTML = `
        <div class="origin-label">${j.terminalName}</div>
        <div class="origin-plate">${j.plate ? j.plate : "No Plate"}</div>
        <div class="origin-count">${j.passengers}/${j.capacity} seats</div>
        <div class="origin-from">From Terminal ${j.terminalId}</div>
      `;
      el.onclick = () => {
        updateInfo(j);
        showSeatModal(j);
      };
      grid.appendChild(el);
    });
  }

  /* ------------------- ARRIVAL LOGIC ------------------- */

  function jeepArrivesAtMain(incoming) {
    mainJeep = {
      id: incoming.id,
      originName: incoming.originName,
      originTerminalId: incoming.originTerminalId,
      passengers: incoming.passengers,
      capacity: incoming.capacity,
      terminalName: "Main Terminal",
      phase: "unloading"
    };
  }

  /* ------------------- MAIN CYCLE ------------------- */

  function simulateMain() {
    // If no jeep at main → take next from queue
    if (!mainJeep && departedQueue.length > 0) {
      jeepArrivesAtMain(departedQueue.shift());
    }

    if (!mainJeep) return;

    if (mainJeep.phase === "unloading") {
      // remove 1-2 passengers (random for realism)
      const remove = 1 + Math.floor(Math.random() * 2);
      mainJeep.passengers = Math.max(0, (mainJeep.passengers || 0) - remove);

      // persist to backend (best-effort)
      fetch(`/api/terminal/${MAIN_TERMINAL_ID}/jeepneys/${mainJeep.id}/passengers`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passengers: mainJeep.passengers })
      }).catch(err => console.error("Failed to update passengers (unload)", err));

      if (mainJeep.passengers === 0) {
        mainJeep.phase = "loading";
      }
    }

    else if (mainJeep.phase === "loading") {
      // add 1-2 passengers
      const add = 1 + Math.floor(Math.random() * 2);
      mainJeep.passengers = Math.min(mainJeep.capacity || CAPACITY, (mainJeep.passengers || 0) + add);

      // persist to backend (best-effort)
      fetch(`/api/terminal/${MAIN_TERMINAL_ID}/jeepneys/${mainJeep.id}/passengers`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passengers: mainJeep.passengers })
      }).catch(err => console.error("Failed to update passengers (load)", err));

      const needed = (mainJeep.capacity || CAPACITY) * MAIN_MIN_FILL;

      if (mainJeep.passengers >= needed) {
        // MAIN → ORIGIN departure
        fetch("/api/trips/depart-from-main", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            jeepney_id: mainJeep.id,
            passengers: mainJeep.passengers
          })
        })
        .then(r => {
          if (!r.ok) return r.json().then(x => { throw x; });
          return r.json();
        })
        .then(() => {
          // after one full cycle, reload data
          loadOriginJeepsFromDB();
          loadMainQueueFromDB();
        })
        .catch(err => console.error("Error depart-from-main:", err));

        mainJeep = null;
      }
    }
  }

  /* ------------------- TICK ------------------- */

  function tick() {
    simulateMain();
    renderOriginJeeps();
    renderQueue();
    renderMainJeep();
  }

  if (!window.__mainTerminalTickId) {
    window.__mainTerminalTickId = setInterval(tick, TICK_MS);
  }
  /* ------------------- LOAD INITIAL DATA ------------------- */

  jeepElems.forEach(el => {
    el.addEventListener("click", () => {
      const idx = parseInt(el.dataset.index, 10);
      const j = originJeeps[idx];
      if (!j || !j.id) return;
      updateInfo(j);
      showSeatModal(j);
    });
  });

  mainJeepBox.addEventListener("click", () => {
    if (!mainJeep) return;
    updateInfo(mainJeep);
    showSeatModal(mainJeep);
  });

  // Load the 4 "origin jeeps" (summary of latest departed jeeps heading to main)
  function loadOriginJeepsFromDB() {
    fetch("/api/main/origin-jeeps")
      .then(r => r.json())
      .then(data => {

        originJeeps = {}; // reset

        data.forEach(row => {
          originJeeps[row.terminal_id] = {
            id: row.jeepney_id,
            terminalId: row.terminal_id,
            terminalName: row.terminal_name,
            plate: row.plate_number,
            passengers: row.passengers ?? 0,
            capacity: row.capacity ?? CAPACITY
          };
        });

        renderOriginJeeps();
      })
      .catch(err => console.error("Origin load error:", err));
  }


  // NEW: load REAL queue at main from DB
  function loadMainQueueFromDB() {
    fetch(`/api/terminal/${MAIN_TERMINAL_ID}/queue`)
      .then(r => r.json())
      .then(data => {
        departedQueue.length = 0;

        data.forEach(row => {
          const capacity = row.capacity ?? CAPACITY;
          const passengers = row.passengers ?? 0;

          departedQueue.push({
            id: row.jeepney_id,
            originName: "Main Terminal Queue",
            originTerminalId: MAIN_TERMINAL_ID,
            passengers,
            capacity,
            terminalName: "Main Terminal"
          });
        });

        // If no jeep currently at main, pull first from queue
        if (!mainJeep && departedQueue.length > 0) {
          jeepArrivesAtMain(departedQueue.shift());
        }

        renderQueue();
        renderMainJeep();
      })
      .catch(err => console.error("Error loading main queue:", err));
  }

  // initial load
  loadOriginJeepsFromDB();
  loadMainQueueFromDB();
</script>

</body>
</html>

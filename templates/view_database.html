{% extends "base.html" %}
{% block title %}Database Content{% endblock %}

{% block head %}
<style>
/* Layout */
.db-layout {
    display: grid;
    grid-template-columns: 240px 1fr;
    gap: 20px;
    align-items: flex-start;
}
@media (max-width: 900px) {
    .db-layout { grid-template-columns: 1fr; }
}

/* Sidebar */
.db-sidebar {
    position: sticky;
    top: 88px;
    background: #ffffff;
    border: 1px solid #e6e9ef;
    border-radius: 10px;
    padding: 16px;
    font-size: 14px;
    box-shadow: 0 6px 18px rgba(15,23,42,0.04);
}
.db-sidebar h3 { margin-top: 0; font-size: 16px; margin-bottom: 10px; }
.db-sidebar ul { list-style: none; padding-left: 0; margin: 0; }
.db-sidebar li { margin-bottom: 8px; }
.db-sidebar a { text-decoration: none; color: #1f6feb; }
.db-sidebar a:hover { text-decoration: underline; }

/* Header */
.db-header h1 { margin: 0 0 6px 0; font-size: 1.6rem; }
.db-header p { margin: 0; color: #556; }

/* Card wrapper for tables */
.table-card {
    background: #fff;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 18px;
    border: 1px solid rgba(15,23,42,0.04);
    box-shadow: 0 6px 18px rgba(15,23,42,0.03);
}

/* Section title row */
.section-title {
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}
.section-title .left {
    display:flex;
    align-items:center;
    gap:12px;
}
.section-title .title-text { font-weight: 700; font-size: 1.05rem; }
.section-controls { display:flex; gap:8px; align-items:center; }

/* Search input & add button */
.table-search {
    border: 1px solid #e2e8f0;
    padding: 8px 10px;
    border-radius: 8px;
    font-size: 0.95rem;
    width: 240px;
}
.btn-add {
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: linear-gradient(90deg,#16a34a,#0ea5a9);
    color: #fff;
}

/* Table */
table.db-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    font-size: 13px;
    table-layout: auto;
}
.db-table thead th {
    background: #0b1220;
    color: #fff;
    text-align: left;
    padding: 10px;
    font-size: 13px;
    position: sticky;
    top: 0;
}
.db-table tbody tr { transition: background 0.12s ease; }
.db-table tbody tr:nth-child(even) { background: #fbfdff; }
.db-table td, .db-table th { padding: 8px 10px; border-bottom: 1px solid rgba(15,23,42,0.04); vertical-align: middle; }

/* Actions */
.actions { white-space: nowrap; }
.actions a { text-decoration:none; }
.actions button {
    font-size: 12px;
    padding: 5px 8px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 6px;
}
.btn-edit { background: #0ea5a9; color: white; }
.btn-delete { background: #ef4444; color: white; }

/* Collapse box hidden state */
.collapsed { display: none; }

/* Responsive tweaks */
@media (max-width: 820px) {
    .table-search { width: 100%; }
    .section-title { flex-direction: column; align-items:flex-start; gap:8px; }
}
</style>
{% endblock %}

{% block content %}

<div class="db-header">
    <h1>üìä Complete Database Viewer</h1>
    <p>View, update, or delete records from your database. Use the sidebar to jump between tables.</p>
</div>

<div class="db-layout">
    <!-- LEFT: QUICK NAV -->
    <aside class="db-sidebar" aria-label="Database navigation">
        <h3>Tables</h3>
        <ul>
            <li><a href="#users">Users</a></li>
            <li><a href="#terminals">Terminals</a></li>
            <li><a href="#jeepneys">Jeepneys</a></li>
            <li><a href="#terminaljeeps">Terminal Queue</a></li>
            <li><a href="#trips">Trips</a></li>
            <li><a href="#seats">Seat Records</a></li>
            <li><a href="#routes">Routes</a></li>
            <li><a href="#userfavorites">User Favorites</a></li>
            <li><a href="#notifications">Notifications</a></li>
            <li><a href="#auditlogs">Audit Logs</a></li>
        </ul>
    </aside>

    <!-- RIGHT: TABLES -->
    <div>
        {% macro render_table(title, items, model_name, id_attr, anchor_id) %}
        <div class="table-card" id="{{ anchor_id }}-card">
            <div class="section-title" id="{{ anchor_id }}">
                <div class="left">
                    <div class="title-text">{{ title }}</div>
                    <div class="muted" style="font-size:0.9rem; color:#6b7280;">
                        &nbsp;¬∑&nbsp;{{ items|length }} record{{ 's' if items|length != 1 }}
                    </div>
                </div>

                <div class="section-controls">
                    <input class="table-search" placeholder="Search {{ title }}..." oninput="filterTable('{{ anchor_id }}', this.value)">
                    <a href="{{ url_for('add_record', model=model_name) }}">
                        <button type="button" class="btn-add">‚ûï Add New</button>
                    </a>
                    <button type="button" class="btn-toggle" onclick="toggleSection('{{ anchor_id }}')">‚ñæ</button>
                </div>
            </div>

            <div id="{{ anchor_id }}-body">
                {% if items|length == 0 %}
                    <p><i>No data found.</i></p>
                {% else %}
                    <table class="db-table" id="{{ anchor_id }}-table" data-model="{{ model_name }}">
                        <thead>
                            <tr>
                                {% for col in items[0].__table__.columns %}
                                    <th>{{ col.name }}</th>
                                {% endfor %}
                                <th>Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for row in items %}
                            <tr>
                                {% for col in row.__table__.columns %}
                                    <td>{{ row|attr(col.name) }}</td>
                                {% endfor %}
                                <td class="actions">
                                    <a href="{{ url_for('update_record', model=model_name, id=row|attr(id_attr)) }}">
                                        <button type="button" class="btn-edit">‚úèÔ∏è Edit</button>
                                    </a>

                                    <form method="post"
                                          action="{{ url_for('delete_record', model=model_name, id=row|attr(id_attr)) }}"
                                          style="display:inline"
                                          onsubmit="return confirm('Are you sure you want to delete this record?');">
                                        <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
        {% endmacro %}

        {{ render_table("Users", data.users, "users", "user_id", "users") }}
        {{ render_table("Terminals", data.terminals, "terminals", "terminal_id", "terminals") }}
        {{ render_table("Jeepneys", data.jeepneys, "jeepneys", "jeepney_id", "jeepneys") }}
        {{ render_table("Terminal Queue (TerminalJeepneys)", data.terminal_queue, "terminaljeeps", "terminal_jeep_id", "terminaljeeps") }}
        {{ render_table("Trips", data.trips, "trips", "trip_id", "trips") }}
        {{ render_table("Seat Records", data.seats, "seats", "trip_seat_id", "seats") }}
        {{ render_table("Routes", data.routes, "routes", "route_id", "routes") }}
        {{ render_table("User Favorites", data.favorites, "userfavorites", "favorite_id", "userfavorites") }}
        {{ render_table("Notifications", data.notifications, "notifications", "notification_id", "notifications") }}
        {{ render_table("Audit Logs", data.auditlogs, "auditlogs", "audit_id", "auditlogs") }}
    </div>
</div>

<!-- Simple client-side helpers: filter & collapse -->
<script>
/* smooth scroll for sidebar anchors */
document.querySelectorAll('.db-sidebar a').forEach(a=>{
    a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href').replace('#','');
        const el = document.getElementById(id);
        if(el) {
            window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 70, behavior: 'smooth' });
        }
    });
});

/* Toggle section collapse */
function toggleSection(anchorId) {
    const body = document.getElementById(anchorId + '-body');
    if (!body) return;
    body.classList.toggle('collapsed');
    const btn = document.querySelector(`#${anchorId} .btn-toggle`);
    if (btn) btn.textContent = body.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
}

/* Filter rows inside a table by text (search in all columns) */
function filterTable(anchorId, text) {
    text = (text || '').trim().toLowerCase();
    const tbody = document.querySelector('#' + anchorId + '-table tbody');
    if(!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach(tr => {
        if(!text) {
            tr.style.display = '';
            return;
        }
        const rowText = tr.innerText.toLowerCase();
        tr.style.display = rowText.indexOf(text) !== -1 ? '' : 'none';
    });
}

/* Optional: initial collapse state for very large tables (uncomment to collapse by default)
document.addEventListener('DOMContentLoaded', ()=>{
    ['auditlogs','notifications','userfavorites'].forEach(id=>{
        const body = document.getElementById(id + '-body');
        if(body) body.classList.add('collapsed');
    });
});
*/
</script>

{% endblock %}
